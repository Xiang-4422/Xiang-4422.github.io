

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/rideordie.png">
  <link rel="icon" href="/img/rideordie.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="XiangYU">
  <meta name="keywords" content="">
  
    <meta name="description" content="synchronizedsynchronized简介线程安全问题的主要来源于JMM的设计，集中在  主内存和工作内存导致内存可见性问题 重排序导致的有序性问题  多线程的意义在于多个线程协作共同完成一件事情，那么多个线程就必然需要访问共享数据。 如何保证共享数据的线程安全问题？即每个线程依次访问该共享变量，synchronize关键字具有让每个线程依次访问共享数据的功能。它是并发容器实现的基础。">
<meta property="og:type" content="article">
<meta property="og:title" content="Java并发-并发关键字">
<meta property="og:url" content="http://example.com/2022/10/14/Java%E5%B9%B6%E5%8F%91-%E5%B9%B6%E5%8F%91%E5%85%B3%E9%94%AE%E5%AD%97/index.html">
<meta property="og:site_name" content="Ride_or_DIE">
<meta property="og:description" content="synchronizedsynchronized简介线程安全问题的主要来源于JMM的设计，集中在  主内存和工作内存导致内存可见性问题 重排序导致的有序性问题  多线程的意义在于多个线程协作共同完成一件事情，那么多个线程就必然需要访问共享数据。 如何保证共享数据的线程安全问题？即每个线程依次访问该共享变量，synchronize关键字具有让每个线程依次访问共享数据的功能。它是并发容器实现的基础。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2022/10/14/Java%E5%B9%B6%E5%8F%91-%E5%B9%B6%E5%8F%91%E5%85%B3%E9%94%AE%E5%AD%97/%E5%AF%B9%E8%B1%A1%E9%94%81.drawio.png">
<meta property="og:image" content="http://example.com/2022/10/14/Java%E5%B9%B6%E5%8F%91-%E5%B9%B6%E5%8F%91%E5%85%B3%E9%94%AE%E5%AD%97/5c09eea06aa64329bdae63dc31aa9622tplv-k3u1fbpfcp-zoom-in-crop-mark4536000.webp">
<meta property="og:image" content="http://example.com/2022/10/14/Java%E5%B9%B6%E5%8F%91-%E5%B9%B6%E5%8F%91%E5%85%B3%E9%94%AE%E5%AD%97/16315cff10307a29tplv-t2oaga2asx-zoom-in-crop-mark4536000.webp">
<meta property="og:image" content="http://example.com/2022/10/14/Java%E5%B9%B6%E5%8F%91-%E5%B9%B6%E5%8F%91%E5%85%B3%E9%94%AE%E5%AD%97/16315d056598e4c2tplv-t2oaga2asx-zoom-in-crop-mark4536000.webp">
<meta property="og:image" content="http://example.com/2022/10/14/Java%E5%B9%B6%E5%8F%91-%E5%B9%B6%E5%8F%91%E5%85%B3%E9%94%AE%E5%AD%97/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpbmF0XzQxODMyMjU1,size_16,color_FFFFFF,t_70.png">
<meta property="og:image" content="http://example.com/2022/10/14/Java%E5%B9%B6%E5%8F%91-%E5%B9%B6%E5%8F%91%E5%85%B3%E9%94%AE%E5%AD%97/16315cb91da523d9tplv-t2oaga2asx-zoom-in-crop-mark4536000.webp">
<meta property="og:image" content="http://example.com/2022/10/14/Java%E5%B9%B6%E5%8F%91-%E5%B9%B6%E5%8F%91%E5%85%B3%E9%94%AE%E5%AD%97/16320e796b904658tplv-t2oaga2asx-zoom-in-crop-mark4536000.png">
<meta property="og:image" content="http://example.com/2022/10/14/Java%E5%B9%B6%E5%8F%91-%E5%B9%B6%E5%8F%91%E5%85%B3%E9%94%AE%E5%AD%97/16320e796b8acbd7tplv-t2oaga2asx-zoom-in-crop-mark4536000.png">
<meta property="og:image" content="http://example.com/2022/10/14/Java%E5%B9%B6%E5%8F%91-%E5%B9%B6%E5%8F%91%E5%85%B3%E9%94%AE%E5%AD%97/16320e796bd467fbtplv-t2oaga2asx-zoom-in-crop-mark4536000.png">
<meta property="og:image" content="http://example.com/2022/10/14/Java%E5%B9%B6%E5%8F%91-%E5%B9%B6%E5%8F%91%E5%85%B3%E9%94%AE%E5%AD%97/16320e796e1471c0tplv-t2oaga2asx-zoom-in-crop-mark4536000.png">
<meta property="og:image" content="http://example.com/2022/10/14/Java%E5%B9%B6%E5%8F%91-%E5%B9%B6%E5%8F%91%E5%85%B3%E9%94%AE%E5%AD%97/16320e796e2f06datplv-t2oaga2asx-zoom-in-crop-mark4536000.png">
<meta property="og:image" content="http://example.com/2022/10/14/Java%E5%B9%B6%E5%8F%91-%E5%B9%B6%E5%8F%91%E5%85%B3%E9%94%AE%E5%AD%97/16320e796e03b351tplv-t2oaga2asx-zoom-in-crop-mark4536000.png">
<meta property="og:image" content="http://example.com/2022/10/14/Java%E5%B9%B6%E5%8F%91-%E5%B9%B6%E5%8F%91%E5%85%B3%E9%94%AE%E5%AD%97/16320e799b76d34ctplv-t2oaga2asx-zoom-in-crop-mark4536000.png">
<meta property="og:image" content="http://example.com/2022/10/14/Java%E5%B9%B6%E5%8F%91-%E5%B9%B6%E5%8F%91%E5%85%B3%E9%94%AE%E5%AD%97/16320f7dbcfd83a2tplv-t2oaga2asx-zoom-in-crop-mark4536000.png">
<meta property="og:image" content="http://example.com/2022/10/14/Java%E5%B9%B6%E5%8F%91-%E5%B9%B6%E5%8F%91%E5%85%B3%E9%94%AE%E5%AD%97/16320f7de16b0ec0tplv-t2oaga2asx-zoom-in-crop-mark4536000.png">
<meta property="article:published_time" content="2022-10-14T13:25:12.000Z">
<meta property="article:modified_time" content="2022-11-09T11:36:38.797Z">
<meta property="article:author" content="XiangYU">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/2022/10/14/Java%E5%B9%B6%E5%8F%91-%E5%B9%B6%E5%8F%91%E5%85%B3%E9%94%AE%E5%AD%97/%E5%AF%B9%E8%B1%A1%E9%94%81.drawio.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>Java并发-并发关键字 - Ride_or_DIE</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.0","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"left","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"oJgRmRSoMnXMSzk2FSqr3T8l-gzGzoHsz","app_key":"2rUmLcHtDRExt0YFmed3951e","server_url":null,"path":"window.location.pathname","ignore_local":true}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>

  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Ride_or_DIE</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Java并发-并发关键字"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-10-14 21:25" pubdate>
          2022年10月14日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          9k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          76 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="padding-left: 2rem; margin-right: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Java并发-并发关键字</h1>
            
              <p class="note note-info">
                
                  
                    本文最后更新于：2022年11月9日 晚上
                  
                
              </p>
            
            <div class="markdown-body">
              
              <h1 id="synchronized"><a href="#synchronized" class="headerlink" title="synchronized"></a>synchronized</h1><h2 id="synchronized简介"><a href="#synchronized简介" class="headerlink" title="synchronized简介"></a>synchronized简介</h2><p>线程安全问题的主要来源于JMM的设计，集中在</p>
<ul>
<li>主内存和工作内存导致内存可见性问题</li>
<li>重排序导致的有序性问题</li>
</ul>
<p>多线程的意义在于多个线程协作共同完成一件事情，那么多个线程就必然需要访问共享数据。</p>
<p>如何保证共享数据的线程安全问题？即每个线程依次访问该共享变量，synchronize关键字具有让每个线程依次访问共享数据的功能。它是并发容器实现的基础。</p>
<h2 id="synchronized实现原理"><a href="#synchronized实现原理" class="headerlink" title="synchronized实现原理"></a>synchronized实现原理</h2><p>sychronized使用场景</p>
<ul>
<li><p>方法</p>
<blockquote>
<p>可以作用于实例方法和静态方法</p>
<p>区别在于被锁对象一个是实例对象，一个是类对象</p>
</blockquote>
</li>
<li><p>代码块（锁住方法相当于锁住整个方法的代码块）</p>
<blockquote>
<p>可以使用各种对象作为锁</p>
<p>this：使用类的实例对象作为锁</p>
<p>.class：使用类对象作为锁</p>
<p>Object：使用任意实例对象作为锁</p>
</blockquote>
</li>
</ul>
<h3 id="对象锁（moniter）机制"><a href="#对象锁（moniter）机制" class="headerlink" title="对象锁（moniter）机制"></a>对象锁（moniter）机制</h3><h4 id="获取与释放对象锁："><a href="#获取与释放对象锁：" class="headerlink" title="获取与释放对象锁："></a>获取与释放对象锁：</h4><p>在编译后的字节码中使用monitorenter指令获取到monitor（对象锁）后才能继续执行代码块中的指令，最后通过monitorexit指令释放所持有的monitor。</p>
<p>正常执行return退出代码块或者抛出异常退出代码块都能够执行monitorexit释放持有的对象锁</p>
<h4 id="对象锁（monitor）"><a href="#对象锁（monitor）" class="headerlink" title="对象锁（monitor）"></a>对象锁（monitor）</h4><p>每个对象都存在一个与之关联的monitor，线程对monitor持有的方式以及持有时机决定了synchronized的锁状态以及synchronized的状态升级方式</p>
<p>monitor是通过C++中的ObjectMonitor实现的：</p>
<p><img src="/2022/10/14/Java%E5%B9%B6%E5%8F%91-%E5%B9%B6%E5%8F%91%E5%85%B3%E9%94%AE%E5%AD%97/%E5%AF%B9%E8%B1%A1%E9%94%81.drawio.png" srcset="/img/loading.gif" lazyload alt="对象锁.drawio"></p>
<ul>
<li>ObjectMonitor维护WaitSet和EntryList两个队列来保存ObjectWaiter对象</li>
<li>EntryList：阻塞等待获取锁的线程会被封装成ObjectWaiter进入EntryList队列，等待锁释放后竞争锁，获取锁后线程执行完成后退出并释放锁。</li>
<li>WaitSet：获取锁的线程若调用wait方法后会进入WaitSet中等待被唤醒，若被唤醒，则线程会进入EntryList中</li>
</ul>
<h3 id="synchronized与happens-before的关系"><a href="#synchronized与happens-before的关系" class="headerlink" title="synchronized与happens-before的关系"></a>synchronized与happens-before的关系</h3><p><img src="/2022/10/14/Java%E5%B9%B6%E5%8F%91-%E5%B9%B6%E5%8F%91%E5%85%B3%E9%94%AE%E5%AD%97/5c09eea06aa64329bdae63dc31aa9622tplv-k3u1fbpfcp-zoom-in-crop-mark4536000.webp" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>箭头表示happens-before</p>
<ul>
<li>程序顺序规则：黑色箭头顺序</li>
<li>监视器锁队则：红色箭头顺序</li>
<li>传递性规则：由上面两个推导出来的蓝色箭头顺序</li>
</ul>
<h3 id="获取锁和释放锁的内存语义"><a href="#获取锁和释放锁的内存语义" class="headerlink" title="获取锁和释放锁的内存语义"></a>获取锁和释放锁的内存语义</h3><p>释放锁：释放锁的时候会将线程对共享变量的修改写回主内存</p>
<p>获取锁：会强制从主内存中获取共享变量的新值</p>
<p>所以从横向看，线程之间基于主内存中的共享变量互相感知对方的数据操作，基于共享变量完成并发实体中的协作工作，整个过程就像是线程发送数据变更的“通知”，这种通知机制就是基于共享内存的并发模型导致的。</p>
<h2 id="synchronized优化"><a href="#synchronized优化" class="headerlink" title="synchronized优化"></a>synchronized优化</h2><p>synchronized最大特征就是同一时刻只能有一个线程能够获取对象的monitor，从何确保线程同步，对于线程之间表现为<strong>互斥性（排他性）</strong></p>
<p>优化的方向：</p>
<ul>
<li>让获取锁的速度变快</li>
<li>降低阻塞等待的概率</li>
</ul>
<p>对于优化需要先了解：</p>
<ul>
<li>CAS</li>
<li>Java对象头</li>
</ul>
<p>具体的优化：（锁升级）</p>
<ul>
<li>无锁</li>
<li>偏向锁</li>
<li>轻量级锁</li>
<li>重量级锁</li>
</ul>
<h3 id="CAS（Compare-And-Swap）"><a href="#CAS（Compare-And-Swap）" class="headerlink" title="CAS（Compare And Swap）"></a>CAS（Compare And Swap）</h3><h4 id="CAS概念"><a href="#CAS概念" class="headerlink" title="CAS概念"></a>CAS概念</h4><p>悲观锁：线程获取锁是一种悲观锁策略，即假设每次执行临界区代码都会产生冲突，所以当前线程获取锁的同时会阻塞其他线程获取该锁</p>
<p>乐观锁：CAS操作（又称无锁操作）是一种乐观锁策略，它假设所有线程访问共享资源的时候不会出现冲突，那么线程之间就不会出现阻塞。CAS操作会检测是否发生了冲突，则发生冲突，CAS会重试直到没有冲突</p>
<h4 id="CAS操作过程"><a href="#CAS操作过程" class="headerlink" title="CAS操作过程"></a>CAS操作过程</h4><p>CAS比较交换的过程可以大概理解为CAS(V, O, N)</p>
<ul>
<li>V（vary）：变量</li>
<li>O（old）：旧值</li>
<li>N（new）：新值</li>
</ul>
<p>过程：（整个过程是基于硬件指令级实现，具有原子性）</p>
<blockquote>
<p>读取V的值，若V &#x3D;&#x3D; O，那么说明内存中的值没有别其他线程修改过，就没有线程冲突，那么即可将N写入V。若V !&#x3D; O，说明该值已经被修改过了，CAS失败。</p>
</blockquote>
<p>Synchronized VS CAS:</p>
<blockquote>
<p>synchronized在存在线程竞争的情况下，会出现线程阻塞和唤醒带来的性能问题，这是一种<strong>阻塞同步</strong></p>
<p>CAS会在CAS操作失败后进行一定的尝试，而不是进行耗时的挂起唤醒操作，因此也叫做<strong>非阻塞同步</strong></p>
</blockquote>
<h4 id="CAS的应用场景"><a href="#CAS的应用场景" class="headerlink" title="CAS的应用场景"></a>CAS的应用场景</h4><ul>
<li><p>concurrency包的实现</p>
</li>
<li><p>Lock实现中CAS该百年state变量</p>
</li>
<li><p>atomic包的实现</p>
</li>
</ul>
<h4 id="CAS的问题"><a href="#CAS的问题" class="headerlink" title="CAS的问题"></a>CAS的问题</h4><ul>
<li><p>ABA问题</p>
<blockquote>
<p>问题：</p>
<p>CAS通过检查旧值是否变化来检测变量是否改变，若变量变化如下A-&gt;B-&gt;A，那么CAS则无法检测到变量的变化</p>
<p>解决方法：</p>
<p>加上版本号1A-&gt;2B-&gt;3A</p>
<p>Java在atomic包中提供了AtomicStampedReference来解决ABA问题</p>
</blockquote>
</li>
<li><p>自旋对CPU的占用带来的性能消耗</p>
<blockquote>
<p>CAS若失败不会将线程挂起释放CPU资源，会进行自旋（死循环）进行重试直到CAS成功，自旋时间过程的话会对性能造成很大消耗</p>
<p>若JVM支持处理器提供的pause指令，可以在效率上有一定提升</p>
</blockquote>
</li>
<li><p>只能保证一个共享变量的原子操作</p>
<blockquote>
<p>问题：</p>
<p>对一个变量执行CAS操作可以保证器原子性，若对多个共享便变量进行操作，CAS就不能保证这个操作的原子性</p>
<p>解决办法：</p>
<p>利用对象整合多个共享变量，对对象执行CAS操作。</p>
<p>atomic包中提供了AtomicReference来保证引用对象之间的原子性</p>
</blockquote>
</li>
</ul>
<h3 id="Java对象头"><a href="#Java对象头" class="headerlink" title="Java对象头"></a>Java对象头</h3><p>如何理解对象锁：</p>
<p>对象锁是对象的一个标志，这个标志存放在Java对象的对象头的Mark Word中。</p>
<p>Mark Word：</p>
<p><img src="/2022/10/14/Java%E5%B9%B6%E5%8F%91-%E5%B9%B6%E5%8F%91%E5%85%B3%E9%94%AE%E5%AD%97/16315cff10307a29tplv-t2oaga2asx-zoom-in-crop-mark4536000.webp" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="/2022/10/14/Java%E5%B9%B6%E5%8F%91-%E5%B9%B6%E5%8F%91%E5%85%B3%E9%94%AE%E5%AD%97/16315d056598e4c2tplv-t2oaga2asx-zoom-in-crop-mark4536000.webp" srcset="/img/loading.gif" lazyload alt="img"></p>
<h3 id="偏向锁"><a href="#偏向锁" class="headerlink" title="偏向锁"></a>偏向锁</h3><p>锁在大多数情况下不存在多线程竞争，并且总是由同一线程多次获得，为减少同一线程获取锁的代价而引入偏向锁</p>
<p><img src="/2022/10/14/Java%E5%B9%B6%E5%8F%91-%E5%B9%B6%E5%8F%91%E5%85%B3%E9%94%AE%E5%AD%97/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpbmF0XzQxODMyMjU1,size_16,color_FFFFFF,t_70.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h4 id="偏向锁逻辑"><a href="#偏向锁逻辑" class="headerlink" title="偏向锁逻辑"></a>偏向锁逻辑</h4><p>通用逻辑：</p>
<ol>
<li>检测锁标志位。若为01，说明处于无锁或偏向锁状态，才能进行偏向锁逻辑判断。</li>
<li>检测偏向锁标志位。若为0，说明是无锁（无锁不可偏向），进入轻量级锁逻辑（CAS竞争锁），若是1说明是偏向锁，进入偏向锁逻辑。</li>
</ol>
<p>偏向锁逻辑：</p>
<ol start="3">
<li>检查Mark Word中的Thread Id。若为当前线程ID说明当前线程已经获取锁，不需要再获取锁，而是往自己的线程栈中添加一条Displaced Mark Word为空的Lock Record，用于重入统计。</li>
</ol>
<blockquote>
<p>偏向锁的释放与偏向锁的撤销：</p>
<p>偏向锁的释放：</p>
<ul>
<li>时机：退出同步代码块</li>
<li>操作：删除线程栈中的Lock Word（不会修改对象头中的锁状态）</li>
</ul>
<p>偏向锁的撤销：</p>
<ul>
<li>时机：发生锁竞争</li>
<li>操作：锁升级或者重偏向</li>
</ul>
</blockquote>
<ol start="4">
<li>若Mark Word中的Thread Id不是当前线程ID，则进行CAS操作替换Thread Id。若当前对象锁处于匿名偏向状态（Thread Id为0，无锁可偏向）CAS会成功，则获取锁，并插入Lock Word到当前线程栈，执行同步代码块</li>
</ol>
<p>锁撤销逻辑：</p>
<ol start="5">
<li>若CAS失败，说明对象锁已经被其他线程占用，进入偏向锁撤销逻辑。</li>
<li>等到全局安全点，暂停持有对象锁的线程，检测其状态，若其存活且在执行同步块代码，则将锁升级为轻量级锁。</li>
<li>若线线程未存活或者存活但未执行同步块代码。若开启重偏向，则将锁置为匿名偏向状态然后CAS获取偏向锁，若没开启重偏向，将锁置为无锁状态，然后升级为轻量级锁。</li>
<li>最后唤醒暂停的线程，从安全点继续执行代码</li>
</ol>
<h4 id="批量重偏向与批量撤销"><a href="#批量重偏向与批量撤销" class="headerlink" title="批量重偏向与批量撤销"></a>批量重偏向与批量撤销</h4><p>为什么有该机制：</p>
<blockquote>
<p>在出现锁竞争，即执行锁撤销逻辑的时候，需要暂停线程，并等到safe point，再撤销锁或升级锁，会消耗一定性能。若多线程竞争频繁，那么偏向锁不会提高性能，反而导致性能下降。</p>
</blockquote>
<p>解决的场景：</p>
<blockquote>
<p> 批量重偏向机制：一个线程创建大量对象，并执行了初始的同步操作，后面另一个线程也将这些对象作为锁对象进行操作，这样就会导致大量的锁撤销操作</p>
<p>批量撤销机制：再多线程竞争激烈的场景下竞争使用偏向锁</p>
</blockquote>
<p>原理：</p>
<blockquote>
<p>偏向锁撤销计数器：以class为单位，为每个class维护一个偏向锁撤销计数器，每次次该class的对象发生偏向撤销操作，该计数器+1</p>
<p>当计数器达到批量重偏向阈值（20）：</p>
<blockquote>
<p>epoch字段：</p>
<p>每个class对象会有一个epoch字段（可以理解为第几代偏向锁），处于偏向锁状态的对象的Mark Word中也有该字段，初始值为创建该对象时class中的epoch值。</p>
<p>批量重偏向操作：</p>
<p>将class中的epoch值+1（表示之前那一代的偏向锁失效）</p>
<p>被线程持有的该class类的锁对象，将其epoch值+1（保证已加锁的线程继续持有锁）（该操作需要等到全局安全点）</p>
<p>已经被线程释放的锁对象，其epoch值没有更新，其他线程去申请锁时，发现对象锁的epoch值与class中的epoch值不一致，则会进行自动重偏向（即不会进行锁撤销，而是直接通过CAS将其MarkWord中的Thread Id改为当前线程）</p>
</blockquote>
<p>当计数器达到批量撤销阈值（40）：</p>
<blockquote>
<p>直接标记该class为不可偏向，之后该class的锁直接走轻量级锁的逻辑</p>
</blockquote>
</blockquote>
<h3 id="轻量级锁"><a href="#轻量级锁" class="headerlink" title="轻量级锁"></a>轻量级锁</h3><h4 id="加锁"><a href="#加锁" class="headerlink" title="加锁"></a>加锁</h4><ol>
<li><p>复制Mark Word。</p>
<blockquote>
<p>线程再执行同步块之前，JVM会先在当前线程的栈帧中创建用于存储锁记录的空间，并将对象头中的Mark Word复制到锁记录中，官方称之为<strong>Displaced Mark Word</strong>。</p>
</blockquote>
</li>
<li><p>CAS替换Mark Word。</p>
<blockquote>
<p>然后线程尝试使用CAS将对象头中的Mark Word替换为指向锁记录的指针。如果成功，当前线程获取锁。</p>
</blockquote>
</li>
<li><p>自旋获取锁。</p>
<blockquote>
<p>如果失败，表示其他线程竞争锁，当前线程便尝试使用自旋来获取锁</p>
</blockquote>
</li>
</ol>
<h4 id="解锁"><a href="#解锁" class="headerlink" title="解锁"></a>解锁</h4><p>使用CAS操作将Displaced Mark Word替换回对象头</p>
<ul>
<li>成功：说明没有竞争发生</li>
<li>失败：说明当前锁存在竞争，锁回膨胀为重量级锁</li>
</ul>
<h3 id="锁比较"><a href="#锁比较" class="headerlink" title="锁比较"></a>锁比较</h3><p><img src="/2022/10/14/Java%E5%B9%B6%E5%8F%91-%E5%B9%B6%E5%8F%91%E5%85%B3%E9%94%AE%E5%AD%97/16315cb91da523d9tplv-t2oaga2asx-zoom-in-crop-mark4536000.webp" srcset="/img/loading.gif" lazyload alt="各种锁的对比"></p>
<h1 id="volatile"><a href="#volatile" class="headerlink" title="volatile"></a>volatile</h1><h2 id="volatile简介"><a href="#volatile简介" class="headerlink" title="volatile简介"></a>volatile简介</h2><blockquote>
<p>被volatile修饰的变量能够保证每个线程能够获取该变量的最新值，从而避免出现数据脏读的现象。</p>
</blockquote>
<p>synchronized是阻塞式同步，在线程竞争激烈的情况下回升级成重量级锁，会执行线程的挂起和唤醒操作。而volatile就可以说是JVM提供的<strong>最轻量级</strong>的同步机制。</p>
<h2 id="volatile实现原理"><a href="#volatile实现原理" class="headerlink" title="volatile实现原理"></a>volatile实现原理</h2><blockquote>
<p>在生成汇编代码的时候会在volatile修饰的共享变量进行写操作的时候会多出<strong>Lock前缀指令</strong></p>
</blockquote>
<h3 id="Lock前缀指令对多核处理器产生的影响"><a href="#Lock前缀指令对多核处理器产生的影响" class="headerlink" title="Lock前缀指令对多核处理器产生的影响"></a>Lock前缀指令对多核处理器产生的影响</h3><ul>
<li>将当前CPU核心缓存行的数据写回系统内存</li>
<li>使其他CPU核心内缓存了该内存地址的数据无效</li>
</ul>
<h3 id="缓存一致性协议"><a href="#缓存一致性协议" class="headerlink" title="缓存一致性协议"></a>缓存一致性协议</h3><p>缓存一致性协议的意义：</p>
<blockquote>
<p>一个CPU核心将更新后的数据写回系统内存，但是其他核心中的数据还是旧的，若使用旧值执行计算就会有问题，缓存一致性协议能够保证个个CPU核心中的缓存是一致的。</p>
</blockquote>
<p>缓存一致性协议的实现：</p>
<blockquote>
<p> 每个核心通过嗅探总线上传播的数据来检查自己缓存的数据是否已经过期。若核心发现缓存行对应的内存地址上数据发生修改，就会将对应缓存行设置为无效状态，当核心需要该数据时，会重新从系统内存中加载数据。</p>
</blockquote>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>Lock前缀指令会引起处理器缓存写回内存</li>
<li>一个处理器的缓存写回内存会导致其他处理器中的缓存失效</li>
<li>处理器读取变量数据，发现本地缓存失效，会从内存中读取最新值</li>
</ul>
<h2 id="volatile的happens-before关系"><a href="#volatile的happens-before关系" class="headerlink" title="volatile的happens-before关系"></a>volatile的happens-before关系</h2><h3 id="并发分析的切入点"><a href="#并发分析的切入点" class="headerlink" title="并发分析的切入点"></a>并发分析的切入点</h3><h4 id="两个核心："><a href="#两个核心：" class="headerlink" title="两个核心："></a>两个核心：</h4><ul>
<li>JMM内存模型</li>
<li>happens-before</li>
</ul>
<h4 id="三大性质："><a href="#三大性质：" class="headerlink" title="三大性质："></a>三大性质：</h4><ul>
<li>原子性</li>
<li>可见性</li>
<li>有序性</li>
</ul>
<h3 id="volatile的happens-befores规则"><a href="#volatile的happens-befores规则" class="headerlink" title="volatile的happens-befores规则"></a>volatile的happens-befores规则</h3><blockquote>
<p>对一个volatile域的写，happens-befors于任意后续对这个volatile域的读</p>
</blockquote>
<p>代码实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VolatileExample</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writer</span><span class="hljs-params">()</span>&#123;<br>        a = <span class="hljs-number">1</span>;          <span class="hljs-comment">//1</span><br>        flag = <span class="hljs-literal">true</span>;   <span class="hljs-comment">//2</span><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reader</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">if</span>(flag)&#123;      <span class="hljs-comment">//3</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> a; <span class="hljs-comment">//4</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>代码实例的happens-before关系图：</p>
<p><img src="/2022/10/14/Java%E5%B9%B6%E5%8F%91-%E5%B9%B6%E5%8F%91%E5%85%B3%E9%94%AE%E5%AD%97/16320e796b904658tplv-t2oaga2asx-zoom-in-crop-mark4536000.png" srcset="/img/loading.gif" lazyload alt="VolatileExample的happens-before关系推导"></p>
<p>happens-before分析：</p>
<p>加锁线程A先执行writer方法，然后线程B执行reader方法。</p>
<p>黑色箭头：程序顺序规则</p>
<p>红色箭头：volatile读写顺序规则</p>
<p>蓝色箭头：传递性规则</p>
<p>线程A happen-before 线程B，操作2 happensbefore 操作3，所以在线程A中的操作flag &#x3D; true可以马上被线程B感知，并且根据传递性规则，操作1 happens-before操作4，保证线程A对a的修改可以被线程B感知。</p>
<h2 id="volatile的内存语义"><a href="#volatile的内存语义" class="headerlink" title="volatile的内存语义"></a>volatile的内存语义</h2><p>还是针对上述代码进行分析，假设线程A执行writer方法，线程B随后执行reader方法，初始线程flag和a为初始状态。</p>
<p>线程A执行volatile写后的状态图：</p>
<p><img src="/2022/10/14/Java%E5%B9%B6%E5%8F%91-%E5%B9%B6%E5%8F%91%E5%85%B3%E9%94%AE%E5%AD%97/16320e796b8acbd7tplv-t2oaga2asx-zoom-in-crop-mark4536000.png" srcset="/img/loading.gif" lazyload alt="线程A执行volatile写后的内存状态图"></p>
<p>线程B读取volatile变量的内存变化：</p>
<p><img src="/2022/10/14/Java%E5%B9%B6%E5%8F%91-%E5%B9%B6%E5%8F%91%E5%85%B3%E9%94%AE%E5%AD%97/16320e796bd467fbtplv-t2oaga2asx-zoom-in-crop-mark4536000.png" srcset="/img/loading.gif" lazyload alt="线程B读volatile后的内存状态图"></p>
<p>从横向看，线程A和线程B之间进行了依次通信，线程A在写volatile变量时，就像是给线程B发送了一个消息，告诉线程B它对应的变量过期了，线程B得知自己的变量过期了，那么线程B需要读取变量的时候就去主存中加载最新值。</p>
<h2 id="volatile的内存语义实现"><a href="#volatile的内存语义实现" class="headerlink" title="volatile的内存语义实现"></a>volatile的内存语义实现</h2><blockquote>
<p>为了性能优化，在不改变正确语义的前提下，允许编译器和处理器的指令重排序，为了实现volatile的内存语义，就需要禁止一些重排序。通过添加<strong>内存屏障</strong>实现</p>
</blockquote>
<p>内存屏障分类：</p>
<p><img src="/2022/10/14/Java%E5%B9%B6%E5%8F%91-%E5%B9%B6%E5%8F%91%E5%85%B3%E9%94%AE%E5%AD%97/16320e796e1471c0tplv-t2oaga2asx-zoom-in-crop-mark4536000.png" srcset="/img/loading.gif" lazyload alt="内存屏障分类表"></p>
<p>JMM针对编译器制定的volatile重排序规则表：</p>
<p><img src="/2022/10/14/Java%E5%B9%B6%E5%8F%91-%E5%B9%B6%E5%8F%91%E5%85%B3%E9%94%AE%E5%AD%97/16320e796e2f06datplv-t2oaga2asx-zoom-in-crop-mark4536000.png" srcset="/img/loading.gif" lazyload alt="volatile重排序规则表"></p>
<p>对于上述规则的简述：</p>
<ul>
<li>禁止volatile读后的任何操作与之重排序</li>
<li>禁止volatile写前的任何操作与之重排序</li>
<li>禁止volatile写于volatile读重排序</li>
</ul>
<p>JMM实现上述规则采用的内存屏障策略：</p>
<ul>
<li>对于volatile写<ul>
<li>写前插入StoreSore屏障</li>
<li>写后插入StoreLoad屏障</li>
</ul>
</li>
<li>对于volatile读<ul>
<li>读后插入LoadLoad屏障</li>
<li>读后插入LoadLoad屏障</li>
</ul>
</li>
</ul>
<p><img src="/2022/10/14/Java%E5%B9%B6%E5%8F%91-%E5%B9%B6%E5%8F%91%E5%85%B3%E9%94%AE%E5%AD%97/16320e796e03b351tplv-t2oaga2asx-zoom-in-crop-mark4536000.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="/2022/10/14/Java%E5%B9%B6%E5%8F%91-%E5%B9%B6%E5%8F%91%E5%85%B3%E9%94%AE%E5%AD%97/16320e799b76d34ctplv-t2oaga2asx-zoom-in-crop-mark4536000.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h1 id="final"><a href="#final" class="headerlink" title="final"></a>final</h1><h2 id="final的具体使用场景"><a href="#final的具体使用场景" class="headerlink" title="final的具体使用场景"></a>final的具体使用场景</h2><h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><h4 id="final成员变量"><a href="#final成员变量" class="headerlink" title="final成员变量"></a>final成员变量</h4><p>每个类的成员变量可以分为<strong>类变量、实例变量</strong>。</p>
<p>final变量必须初始化，系统不会进行隐式初始化。</p>
<p>成员变量的赋初值时机：</p>
<ul>
<li>类变量：<ul>
<li>在声明的时候直接赋初值</li>
<li>在静态代码块中给类变量赋初值</li>
</ul>
</li>
<li>实例变量：<ul>
<li>声明变量的时候给实例变量赋初值</li>
<li>在非静态代码块中赋初值</li>
<li>在构造器中赋初值</li>
</ul>
</li>
</ul>
<h4 id="final局部变量"><a href="#final局部变量" class="headerlink" title="final局部变量"></a>final局部变量</h4><p>final局部变量在方法中定义，<strong>形参或者方法体内</strong></p>
<p>若final变量未在定义的时候初始化，可以在方法体内有一次赋值机会，赋值之后再次赋值就会出错。</p>
<p><img src="/2022/10/14/Java%E5%B9%B6%E5%8F%91-%E5%B9%B6%E5%8F%91%E5%85%B3%E9%94%AE%E5%AD%97/16320f7dbcfd83a2tplv-t2oaga2asx-zoom-in-crop-mark4536000.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h4 id="final基本数据类型-VS-final引用数据类型"><a href="#final基本数据类型-VS-final引用数据类型" class="headerlink" title="final基本数据类型 VS final引用数据类型"></a>final基本数据类型 VS final引用数据类型</h4><p>final保证其修饰的变量有且只有一次赋值机会，赋值过后不会再该改变。</p>
<p>基本数据类型：</p>
<p>变量保存的是数据本身，所以数据不能修改。</p>
<p>引用数据类型：</p>
<p>变量保存的是对象的引用，就是说这个变量保存的应用不能变，即变量只能指向该对象，不能指向其他对象。但是对象本身的属性是可以改变的。</p>
<h4 id="宏变量"><a href="#宏变量" class="headerlink" title="宏变量"></a>宏变量</h4><blockquote>
<p>宏变量即常量，在程序中使用到宏变量的地方，编译器会直接将宏变量替换未该变量的字面值</p>
</blockquote>
<p>成为宏变量需要满足的三个条件：</p>
<ul>
<li>使用final修饰符修饰</li>
<li>在定义变量的时候就指定了初始值</li>
<li>该初始值在编译时就能唯一确定</li>
</ul>
<h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><ul>
<li><p>被final修饰的方法不能够被子类重写</p>
</li>
<li><p>被final修饰的方可以重载</p>
</li>
</ul>
<h3 id="类"><a href="#类" class="headerlink" title="类"></a>类</h3><p>当一个类被final修饰的时候，表示该类时不能被子类继承的。</p>
<p>子类继承往往可以重写父类的方法和改变父类属性，会带来一定的安全隐患，因此当一个类希望不被继承的时候就可以使用final修饰。</p>
<h3 id="final使用的例子"><a href="#final使用的例子" class="headerlink" title="final使用的例子"></a>final使用的例子</h3><h4 id="不变类"><a href="#不变类" class="headerlink" title="不变类"></a>不变类</h4><p>定义：</p>
<p>不变类的意思时创建该类的实例后，该实例的实例变量时不可改变的。</p>
<p>成为不变类需要满足的条件：</p>
<ul>
<li>使用private和final修饰符修饰该类的成员变量</li>
<li>提供带参的构造器用于初始化类的成员变量</li>
<li>仅为该类的成员变量提供getter方法，不提供setter方法</li>
<li>有必要的话重写hashCode()和equals()方法，保证用equals判断相同的两个对象其Hashcode值也是相等的</li>
</ul>
<h4 id="JDK中提供的不变类"><a href="#JDK中提供的不变类" class="headerlink" title="JDK中提供的不变类"></a>JDK中提供的不变类</h4><p>String类、八个包装类 </p>
<h2 id="多线程中的final域重排序"><a href="#多线程中的final域重排序" class="headerlink" title="多线程中的final域重排序"></a>多线程中的final域重排序</h2><h3 id="final域为基本类型"><a href="#final域为基本类型" class="headerlink" title="final域为基本类型"></a>final域为基本类型</h3><h4 id="写final域重排序规则"><a href="#写final域重排序规则" class="headerlink" title="写final域重排序规则"></a>写final域重排序规则</h4><blockquote>
<p> 禁止对final域的写重排序到构造函数之外。</p>
</blockquote>
<p>实现：</p>
<ul>
<li>对于编译器：JMM禁止编译器把final域的写重排序到构造函数之外</li>
<li>对于处理器：编译器在final域写之后，构造函数return之前，插入一个storestore屏障。该屏障可以禁止处理器把final域的写重排序到构造函数之外</li>
</ul>
<p>该规则确保：</p>
<p>在对象引用为任意线程可见之前，对象的final域已经被正确初始化过了，而普通域就不具备这个保证。</p>
<h4 id="读final域重排序规则"><a href="#读final域重排序规则" class="headerlink" title="读final域重排序规则"></a>读final域重排序规则</h4><blockquote>
<p> 在一个线程中，初次读对象引用和初次读该对象包含的final域，JMM会禁止这两个操作的重排序。（这个规则针对处理器）</p>
</blockquote>
<p>实现：</p>
<p>编译器在读final域操作前插入LoadLoad屏障。（实际上，读对象的引用和对该对象的final域存在简介依赖性，一般处理不会重排序这两个操作，但是有些处理器会，这个禁止重排序规则就是针对这些处理器而设定的）</p>
<p>该规则确保：</p>
<p>在读一个对象的final域之前，一定会先读这个包含final域的对象的引用</p>
<h3 id="final域为引用类"><a href="#final域为引用类" class="headerlink" title="final域为引用类"></a>final域为引用类</h3><h4 id="对final修饰的成员域写操作"><a href="#对final修饰的成员域写操作" class="headerlink" title="对final修饰的成员域写操作"></a>对final修饰的成员域写操作</h4><blockquote>
<p>在构造函数内对一个final修饰的对象的成员域的写入，与随后在构造函数之外把这个被构造的对象的引用赋给一个引用变量，这两个操作不能重排序</p>
</blockquote>
<h4 id="对final修饰的对象的成员域读操作"><a href="#对final修饰的对象的成员域读操作" class="headerlink" title="对final修饰的对象的成员域读操作"></a>对final修饰的对象的成员域读操作</h4><p>JMM不保证单独对final修饰对象的成员域的修改，与读取final修饰对象的成员域之间的重排序</p>
<h2 id="final的实现原理"><a href="#final的实现原理" class="headerlink" title="final的实现原理"></a>final的实现原理</h2><ul>
<li>final域写后插入StoreStore屏障</li>
<li>final域读前插入LoadLoad屏障</li>
</ul>
<h2 id="为什么final引用不能从构造函数中“逸出”"><a href="#为什么final引用不能从构造函数中“逸出”" class="headerlink" title="为什么final引用不能从构造函数中“逸出”"></a>为什么final引用不能从构造函数中“逸出”</h2><p>final域写重排序规则确保在使用一个对象引用的时候该对象的final域已经在构造函数中被初始化过了。</p>
<p>但是这儿其实有一个前提条件：</p>
<p>在构造函数结束之前，不能让这个被构造的对象被其他线程可件，也就是说该对象引用不能再构造函数中“逸出”</p>
<p>逸出的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FinalReferenceEscapeDemo</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> a;<br>    <span class="hljs-keyword">private</span> FinalReferenceEscapeDemo referenceDemo;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">FinalReferenceEscapeDemo</span><span class="hljs-params">()</span> &#123;<br>        a = <span class="hljs-number">1</span>;  <span class="hljs-comment">//1</span><br>        referenceDemo = <span class="hljs-built_in">this</span>; <span class="hljs-comment">//2</span><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writer</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">FinalReferenceEscapeDemo</span>();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reader</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (referenceDemo != <span class="hljs-literal">null</span>) &#123;  <span class="hljs-comment">//3</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> referenceDemo.a; <span class="hljs-comment">//4</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>线程A执行writer方法，线程B执行reader方法</p>
<p><img src="/2022/10/14/Java%E5%B9%B6%E5%8F%91-%E5%B9%B6%E5%8F%91%E5%85%B3%E9%94%AE%E5%AD%97/16320f7de16b0ec0tplv-t2oaga2asx-zoom-in-crop-mark4536000.png" srcset="/img/loading.gif" lazyload alt="final域引用可能的执行时序"></p>
<p>在线程A中操作1和操作2没有依赖关系，所以操作2可以排在操作1前（操作2是让自己引用自己），这样在构造函数还没结束的时候，线程B已经拿到了构造的对象，但是这个对象还没有构造完成（构造函数还没有结束），此时线程B读final域会读到还未初始化的final域值。</p>
<h1 id="三大性质"><a href="#三大性质" class="headerlink" title="三大性质"></a>三大性质</h1><h2 id="原子性"><a href="#原子性" class="headerlink" title="原子性"></a>原子性</h2><blockquote>
<p>一个操作时不可中断的，要么全部执行成功，要么全部执行失败，有着“同生共死”的感觉</p>
</blockquote>
<h3 id="JMM中的8个原子操作"><a href="#JMM中的8个原子操作" class="headerlink" title="JMM中的8个原子操作"></a>JMM中的8个原子操作</h3><ul>
<li>lock</li>
<li>unlock</li>
<li>read</li>
<li>load</li>
<li>use</li>
<li>assign</li>
<li>store</li>
<li>write</li>
</ul>
<h3 id="JVM提供的原子性保证："><a href="#JVM提供的原子性保证：" class="headerlink" title="JVM提供的原子性保证："></a>JVM提供的原子性保证：</h3><ul>
<li><p>基本数据类型的访问读写具有原子性（除了long和double）</p>
<blockquote>
<p>原子性变量操作 read、load、use、assign、store、write</p>
</blockquote>
</li>
<li><p>synchronized满足原子性</p>
<blockquote>
<p>lock和unlock虽然没有开放使用，但是反映到JVM则是以monitorenter和monitorexit指令开放使用，反映到Java代码中则是synchronized关键字</p>
</blockquote>
</li>
<li><p>volatile不能保证原子性</p>
<blockquote>
<p>若要让volatile保证原子性需要符合两条规则</p>
<ul>
<li>运算结果不依赖于变量的当前值，或者确保只有一个线程修改便变量的值</li>
<li>变量不需要域其他的状态变量共同参与不变约束</li>
</ul>
</blockquote>
</li>
</ul>
<h2 id="有序性"><a href="#有序性" class="headerlink" title="有序性"></a>有序性</h2><h3 id="synchronized-1"><a href="#synchronized-1" class="headerlink" title="synchronized"></a>synchronized</h3><blockquote>
<p>锁被占用后其他线程只能等待，所以synchronized具有有序性</p>
</blockquote>
<h3 id="volatile-1"><a href="#volatile-1" class="headerlink" title="volatile"></a>volatile</h3><blockquote>
<p>volatile包含禁止指令重排序的语义，器具有有序性</p>
</blockquote>
<h4 id="Java程序的天然有序性可以总结为："><a href="#Java程序的天然有序性可以总结为：" class="headerlink" title="Java程序的天然有序性可以总结为："></a>Java程序的天然有序性可以总结为：</h4><p>如过在本线程内观察，所有操作都是有序的；如果在一个线程中观察另一个线程，所有操作都是无序的。即as-if-serial语义。</p>
<h4 id="DCL（双重检查锁定-Double-Checked-Locking）例子："><a href="#DCL（双重检查锁定-Double-Checked-Locking）例子：" class="headerlink" title="DCL（双重检查锁定 Double-Checked Locking）例子："></a>DCL（双重检查锁定 Double-Checked Locking）例子：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton</span><span class="hljs-params">()</span> &#123; &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">static</span> Singleton instance;<br>    <span class="hljs-keyword">public</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">if</span>(instance==<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">synchronized</span> (Singleton.class)&#123;<br>                <span class="hljs-keyword">if</span>(instance==<span class="hljs-literal">null</span>)&#123;<br>                    instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> instance;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>重点在于为什么对instance加volatile</strong></p>
<blockquote>
<p>instance &#x3D; new Singleton();</p>
<p>该语句实际包含三个操作：</p>
<ol>
<li><p>分配对象的内存空间</p>
</li>
<li><p>初始化对象</p>
</li>
<li><p>设置instance指向刚分配的内存地址</p>
</li>
</ol>
</blockquote>
<p>重排序带来的问题：</p>
<p>重排序可能会导致操作3发生在操作2之前，即对象还没有初始化，instance对象的引用已经可以获取。相当于其他线程可能会拿到还没有初始化完成的instance对象的引用。</p>
<p>volatile解决：</p>
<p>使用volatile修饰instance对象，可以禁止2和3的重排序，避免上述问题。</p>
<ul>
<li><p>1、2、3操作在单线程中要满足as-if-serial语义</p>
</li>
<li><p>为volatile变量instance赋值happens-before读instance变量</p>
</li>
<li><p>传递性原则可以推导出，在对instance的初始化发生于对instance对象的访问前</p>
</li>
</ul>
<h2 id="可见性"><a href="#可见性" class="headerlink" title="可见性"></a>可见性</h2><p>synchronized锁释放会将共享变量写回主内存，锁获取会从主内存获取共享变量的最新值。</p>
<p>volatile变量的读写都会立即更新</p>
<p>所以说synchronized和volatile都具有见性</p>
<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><ul>
<li>synchronized：具有原子性、有序性和可见性</li>
<li>volatile：具有有序性和可见性</li>
</ul>

              
            </div>
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Java%E5%B9%B6%E5%8F%91/" class="category-chain-item">Java并发</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Java并发-并发关键字</div>
      <div>http://example.com/2022/10/14/Java并发-并发关键字/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>XiangYU</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年10月14日</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>更新于</div>
          <div>2022年11月9日</div>
        </div>
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/10/15/Java%E5%B9%B6%E5%8F%91-Lock%E4%B8%8EAQS%E5%88%9D%E8%AF%86/" title="Java并发-Lock与AQS初识">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Java并发-Lock与AQS初识</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/10/14/Java%E5%B9%B6%E5%8F%91-Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/" title="Java并发-Java内存模型">
                        <span class="hidden-mobile">Java并发-Java内存模型</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.4.16/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"oJgRmRSoMnXMSzk2FSqr3T8l-gzGzoHsz","appKey":"2rUmLcHtDRExt0YFmed3951e","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>
  </div>
</div>





  



  



  



  



  






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  

  

  

  

  

  

  
    
  




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.0/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script>
  (function() {
    var enableLang = CONFIG.code_language.enable && CONFIG.code_language.default;
    var enableCopy = CONFIG.copy_btn;
    if (!enableLang && !enableCopy) {
      return;
    }

    function getBgClass(ele) {
      return Fluid.utils.getBackgroundLightness(ele) >= 0 ? 'code-widget-light' : 'code-widget-dark';
    }

    var copyTmpl = '';
    copyTmpl += '<div class="code-widget">';
    copyTmpl += 'LANG';
    copyTmpl += '</div>';
    jQuery('.markdown-body pre').each(function() {
      var $pre = jQuery(this);
      if ($pre.find('code.mermaid').length > 0) {
        return;
      }
      if ($pre.find('span.line').length > 0) {
        return;
      }

      var lang = '';

      if (enableLang) {
        lang = CONFIG.code_language.default;
        if ($pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2 && $pre.children().hasClass('hljs')) {
          lang = $pre[0].children[0].classList[1];
        } else if ($pre[0].getAttribute('data-language')) {
          lang = $pre[0].getAttribute('data-language');
        } else if ($pre.parent().hasClass('sourceCode') && $pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2) {
          lang = $pre[0].children[0].classList[1];
          $pre.parent().addClass('code-wrapper');
        } else if ($pre.parent().hasClass('markdown-body') && $pre[0].classList.length === 0) {
          $pre.wrap('<div class="code-wrapper"></div>');
        }
        lang = lang.toUpperCase().replace('NONE', CONFIG.code_language.default);
      }
      $pre.append(copyTmpl.replace('LANG', lang).replace('code-widget">',
        getBgClass($pre[0]) + (enableCopy ? ' code-widget copy-btn" data-clipboard-snippet><i class="iconfont icon-copy"></i>' : ' code-widget">')));

      if (enableCopy) {
        Fluid.utils.createScript('https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js', function() {
          var clipboard = new window.ClipboardJS('.copy-btn', {
            target: function(trigger) {
              var nodes = trigger.parentNode.childNodes;
              for (var i = 0; i < nodes.length; i++) {
                if (nodes[i].tagName === 'CODE') {
                  return nodes[i];
                }
              }
            }
          });
          clipboard.on('success', function(e) {
            e.clearSelection();
            e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-copy', 'icon-success');
            setTimeout(function() {
              e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-success', 'icon-copy');
            }, 2000);
          });
        });
      }
    });
  })();
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>

  <script defer src="/js/leancloud.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
